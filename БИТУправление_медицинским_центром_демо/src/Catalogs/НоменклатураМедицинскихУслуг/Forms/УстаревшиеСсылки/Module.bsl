#Область ОбработчикиСобытийФормы
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	Номенклатура.Ссылка,
	|	Номенклатура.НоменклатураМедицинскихУслуг.Код КАК КодНМУ
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|ГДЕ
	|	Номенклатура.НоменклатураМедицинскихУслуг <> ЗНАЧЕНИЕ(справочник.НоменклатураМедицинскихУслуг.ПустаяСсылка)
	|	И (Номенклатура.НоменклатураМедицинскихУслуг.ПометкаУдаления ИЛИ Номенклатура.НоменклатураМедицинскихУслуг.Архив)";
	
	ВыборкаДетальныеЗаписи = Запрос.Выполнить().Выбрать();

	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		НовСтр = ТЗ.Добавить();
		НовСтр.Номенклатура = ВыборкаДетальныеЗаписи.Ссылка;
		НовСтр.СтарыйКод = ВыборкаДетальныеЗаписи.КодНМУ;		
	КонецЦикла; 
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура Обновить(Команда)
	ОбновитьНаСервере();
	Если ТЗ.Количество()=0 Тогда 
		Закрыть();
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(НСтр("ru ='Больше нет устаревших ссылок!'")); 
	КонецЕсли;	
КонецПроцедуры

&НаСервере
Процедура ОбновитьИПереименоватьНаСервере()
	Сч=0;
	Пока Сч < ТЗ.Количество() Цикл
		Если ЗначениеЗаполнено(ТЗ[Сч].НовыйКод) Тогда 
			МУОбъект = ТЗ[Сч].Номенклатура.ПолучитьОбъект();
			МУОбъект.НоменклатураМедицинскихУслуг = ТЗ[Сч].НовыйКод;
			МУОбъект.Наименование = ТЗ[Сч].НовыйКод.ПолноеНаименование;
			Попытка
			  МУОбъект.Записать();
			  ТЗ.Удалить(Сч);
			Исключение
			  Сч = Сч + 1;
			КонецПопытки;
		Иначе
			Сч = Сч + 1;
		КонецЕсли		
	КонецЦикла;	
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьИПереименовать(Команда)
	ОбновитьИПереименоватьНаСервере();
	Если ТЗ.Количество()=0 Тогда 	
		Закрыть();
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(НСтр("ru ='Больше нет устаревших ссылок!'")); 
	КонецЕсли;
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции
&НаСервере
Процедура ОбновитьНаСервере()
	Сч=0;
	Пока Сч < ТЗ.Количество() Цикл
		Если ЗначениеЗаполнено(ТЗ[Сч].НовыйКод) Тогда 
			МУОбъект = ТЗ[Сч].Номенклатура.ПолучитьОбъект();
			МУОбъект.НоменклатураМедицинскихУслуг = ТЗ[Сч].НовыйКод;
			Попытка
			  МУОбъект.Записать();
			  ТЗ.Удалить(Сч);
			Исключение
			  Сч = Сч + 1;
			КонецПопытки;
		Иначе
			Сч = Сч + 1;
		КонецЕсли		
	КонецЦикла;	
КонецПроцедуры

#КонецОбласти

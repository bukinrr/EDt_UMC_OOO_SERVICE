<?xml version="1.0" encoding="UTF-8"?>
<ФайлОбмена ВерсияФормата="2.0" ДатаВыгрузки="2021-02-10T18:37:20" НачалоПериодаВыгрузки="0001-01-01T00:00:00" ОкончаниеПериодаВыгрузки="0001-01-01T00:00:00" ИмяКонфигурацииИсточника="БИТУправлениеМедицинскимЦентром" ИмяКонфигурацииПриемника="БИТУправлениеМедицинскимЦентром" ИдПравилКонвертации="8eb077a7-235e-45f8-8b9d-2fc39915dcf1" Комментарий="">
<ПравилаОбмена>
	<ВерсияФормата>2.01</ВерсияФормата>
	<Ид>8eb077a7-235e-45f8-8b9d-2fc39915dcf1</Ид>
	<Наименование>ЗначенияВычисляемыхБлоков</Наименование>
	<ДатаВремяСоздания>2018-08-20T13:56:57</ДатаВремяСоздания>
	<Источник>БИТУправлениеМедицинскимЦентром</Источник>
	<Приемник>БИТУправлениеМедицинскимЦентром</Приемник>
	<Параметры/>
	<Обработки/>
	<ПравилаКонвертацииОбъектов>
		<Правило>
			<Код>ВычисляемыеЗначенияПараметров</Код>
			<СинхронизироватьПоИдентификатору>true</СинхронизироватьПоИдентификатору>
			<Источник>СправочникСсылка.ВычисляемыеЗначенияПараметров</Источник>
			<Приемник>СправочникСсылка.ВычисляемыеЗначенияПараметров</Приемник>
		</Правило>
		<Правило>
			<Код>ПолучателиВычисляемогоЗначения</Код>
			<Источник>ПеречислениеСсылка.ПолучателиВычисляемогоЗначения</Источник>
			<Приемник>ПеречислениеСсылка.ПолучателиВычисляемогоЗначения</Приемник>
		</Правило>
		<Правило>
			<Код>ПараметрыHTML</Код>
			<СинхронизироватьПоИдентификатору>true</СинхронизироватьПоИдентификатору>
			<Источник>ПланВидовХарактеристикСсылка.ПараметрыHTML</Источник>
			<Приемник>ПланВидовХарактеристикСсылка.ПараметрыHTML</Приемник>
		</Правило>
	</ПравилаКонвертацииОбъектов>
	<ПравилаОчисткиДанных/>
	<Алгоритмы/>
	<Запросы/>
</ПравилаОбмена>
<Объект Нпп="1" Тип="СправочникСсылка.ВычисляемыеЗначенияПараметров" ИмяПравила="ВычисляемыеЗначенияПараметров"><Ссылка Нпп="1">
	<Свойство Имя="{УникальныйИдентификатор}" Тип="Строка">
		<Значение>145efe2d-6ba2-11eb-82d3-40167e631f2e</Значение>
	</Свойство>
	<Свойство Имя="Наименование" Тип="Строка">
		<Значение>Блок HTML: Анамнез жизни</Значение>
	</Свойство>
	<Свойство Имя="ЭтоГруппа" Тип="Булево">
		<Значение>false</Значение>
	</Свойство>
</Ссылка>
	<Свойство Имя="АлгоритмВычисления" Тип="Строка">
		<Значение>Заголовок = "";
// Заголовок = Нстр("ru='Анамнез жизни'");

Клиент = ДокументОбъект.Клиент;

Запрос = Новый Запрос;
Запрос.Текст ="ВЫБРАТЬ
| АнамнезЖизни.Параметр,
| АнамнезЖизни.Значение
|ИЗ
| РегистрСведений.АнамнезыЖизни.СрезПоследних(, Клиент = &amp;Клиент) КАК АнамнезЖизни";

Запрос.УстановитьПараметр("Клиент", Клиент); 
ВыборкаЗапроса = Запрос.Выполнить().Выбрать(); 

Если ВыборкаЗапроса.Количество() &lt;&gt; 0 Тогда
	
	Текст = "&lt;TABLE style='BORDER-COLLAPSE: collapse;  margin-left=10pt'  bordercolor='black' border='0' width='100%'&gt;
	|&lt;TBODY&gt;";
	
	Попытка
		Если ЗначениеЗаполнено(Заголовок) Тогда
			Текст = Заголовок + "&lt;BR&gt;" + Текст;
		КонецЕсли;
	Исключение КонецПопытки;
	
	ШаблонЯчейки = "&lt;TD valign='top' style='WORD-WRAP: break-word'&gt;%ТекстПараметр&lt;/TD&gt;";
	
	НомерКолонки = 1;
	ВсегоКолонок = 2;
	КонецВыборки = Ложь;
	
	Пока Истина Цикл
		
		Если ВыборкаЗапроса.Следующий() Тогда
			ТекстПараметр = СокрЛП(Строка(ВыборкаЗапроса.Параметр)) + ": " + Строка(ВыборкаЗапроса.Значение);
		Иначе
			КонецВыборки = Истина;
			ТекстПараметр = "";
		КонецЕсли;
		
		// Начало строки.
		Если НомерКолонки = 1 Тогда
			Если КонецВыборки Тогда
				Прервать;
			Иначе
				Текст = Текст + "&lt;TR&gt;"; // Начинаем новую строку.
			КонецЕсли;
		КонецЕсли;
		
		Текст = Текст + СтрЗаменить(ШаблонЯчейки, "%ТекстПараметр", ТекстПараметр);
		
		// Конец строки.
		Если НомерКолонки = ВсегоКолонок Тогда
			Текст = Текст + "&lt;/TR&gt;";
		КонецЕсли;
		
		НомерКолонки = ?(НомерКолонки &lt; ВсегоКолонок, НомерКолонки + 1, 1);
		
	КонецЦикла;
	
	Текст = Текст + "&lt;/TBODY&gt;&lt;/TABLE&gt;";
	Результат = Текст;
	
КонецЕсли;</Значение>
	</Свойство><Свойство Имя="ПолучательВычисляемогоЗначения" Тип="ПеречислениеСсылка.ПолучателиВычисляемогоЗначения">
	<Значение>ВычисляемыйБлок</Значение>
</Свойство>
	<Свойство Имя="ПометкаУдаления" Тип="Булево">
		<Значение>false</Значение>
	</Свойство><Свойство Имя="Родитель" Тип="СправочникСсылка.ВычисляемыеЗначенияПараметров">
	<Пусто/>
</Свойство><ТабличнаяЧасть Имя="СвязанныеРеквизиты"/><ТабличнаяЧасть Имя="СписокПеременных"/>
</Объект>
<Объект Нпп="3" Тип="СправочникСсылка.ВычисляемыеЗначенияПараметров" ИмяПравила="ВычисляемыеЗначенияПараметров"><Ссылка Нпп="3">
	<Свойство Имя="{УникальныйИдентификатор}" Тип="Строка">
		<Значение>1bed841d-6ba1-11eb-82d3-40167e631f2e</Значение>
	</Свойство>
	<Свойство Имя="Наименование" Тип="Строка">
		<Значение>Блок HTML: Выписанные рецепты</Значение>
	</Свойство>
	<Свойство Имя="ЭтоГруппа" Тип="Булево">
		<Значение>false</Значение>
	</Свойство>
</Ссылка>
	<Свойство Имя="АлгоритмВычисления" Тип="Строка">
		<Значение>Заголовок = 
		"&lt;br/&gt;" + 
		НСтр("ru='Выписанные рецепты:'"); // Можно удалить, если в шаблонах не нужен.

Текст = "";

Запрос = Новый Запрос;
Запрос.Текст = 
"ВЫБРАТЬ
|	Рецепт.Номенклатура1 КАК Номенклатура1,
|	Рецепт.Дозировка1 КАК Дозировка1,
|	Рецепт.СпособПрименения1 КАК СпособПрименения1,
|	Рецепт.РазВДень1 КАК РазВДень1,
|	Рецепт.СколькоДней1 КАК СколькоДней1,
|	Рецепт.Номенклатура2 КАК Номенклатура2,
|	Рецепт.Дозировка2 КАК Дозировка2,
|	Рецепт.СпособПрименения2 КАК СпособПрименения2,
|	Рецепт.РазВДень2 КАК РазВДень2,
|	Рецепт.СколькоДней2 КАК СколькоДней2,
|	Рецепт.Номенклатура3 КАК Номенклатура3,
|	Рецепт.Дозировка3 КАК Дозировка3,
|	Рецепт.СпособПрименения3 КАК СпособПрименения3,
|	Рецепт.РазВДень3 КАК РазВДень3,
|	Рецепт.СколькоДней3 КАК СколькоДней3
|ИЗ
|	Документ.Рецепт КАК Рецепт
|ГДЕ
|	Рецепт.Прием = &amp;Прием И НЕ Рецепт.ПометкаУдаления";

Запрос.УстановитьПараметр("Прием", ДокументОбъект.Ссылка);

Выборка = Запрос.Выполнить().Выбрать();

Пока Выборка.Следующий() Цикл
	
	Для НомерНоменклатуры = 1 По 3 Цикл
		Номенклатура = Выборка["Номенклатура"+НомерНоменклатуры];
		Если ЗначениеЗаполнено(Номенклатура) Тогда
			ДанныеРецепта = Новый Массив;
			ДанныеРецепта.Добавить(Строка(Номенклатура));
			
			// Разовая доза
			Если ЗначениеЗаполнено(Выборка["Дозировка"+НомерНоменклатуры]) Тогда
				ДанныеРецепта.Добавить("разовая доза: " + Строка(Выборка["Дозировка"+НомерНоменклатуры]));
			КонецЕсли;
			
			// Способ применения
			Если ЗначениеЗаполнено(Выборка["СпособПрименения"+НомерНоменклатуры]) Тогда
				ДанныеРецепта.Добавить("способ приема: " + Строка(Выборка["СпособПрименения"+НомерНоменклатуры]));
			КонецЕсли;
			
			// Приёмов в день
			Если ЗначениеЗаполнено(Выборка["РазВДень"+НомерНоменклатуры]) Тогда
				ДанныеРецепта.Добавить("приемов в день: " + Строка(Выборка["РазВДень"+НомерНоменклатуры]));
			КонецЕсли;
			
			// Курс
			ДлительностьКурса = Выборка["СколькоДней"+НомерНоменклатуры];
			Если ЗначениеЗаполнено(ДлительностьКурса) Тогда
				ДанныеРецепта.Добавить("длительность курса: "	+ Строка(ДлительностьКурса)
																+ " " + ПользователиСлужебныйКлиентСервер.ПредметЦелогоЧисла(ДлительностьКурса, "Л = ru_RU", НСтр("ru = 'день,дня,дней,,,,,,0'")));
			КонецЕсли;
			
			Текст = Текст + "&lt;br/&gt;&amp;nbsp;" + СтрСоединить(ДанныеРецепта, ", ");
			
		КонецЕсли;
	КонецЦикла;
КонецЦикла;

Если ЗначениеЗаполнено(Текст) Тогда
	Текст = Заголовок + Текст;
КонецЕсли;

Результат = Текст;</Значение>
	</Свойство><Свойство Имя="ПолучательВычисляемогоЗначения" Тип="ПеречислениеСсылка.ПолучателиВычисляемогоЗначения">
	<Значение>ВычисляемыйБлок</Значение>
</Свойство>
	<Свойство Имя="ПометкаУдаления" Тип="Булево">
		<Значение>false</Значение>
	</Свойство><Свойство Имя="Родитель" Тип="СправочникСсылка.ВычисляемыеЗначенияПараметров">
	<Пусто/>
</Свойство><ТабличнаяЧасть Имя="СвязанныеРеквизиты"/><ТабличнаяЧасть Имя="СписокПеременных"/>
</Объект>
</ФайлОбмена>

#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Если НЕ ЗначениеЗаполнено(Параметры.Дата) Тогда
		Дата = ТекущаяДата();
	КонецЕсли;
	ВладелецКарты = Параметры.Владелец;
	КартыТолькоВладельца = Параметры.КартыТолькоВладельца;
	
	Элементы.ВладелецКарты.Видимость = ПоказыватьКартыРодственников Или Не ЗначениеЗаполнено(ВладелецКарты);
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)

	Если Не Параметры.КартыТолькоВладельца Тогда
		ПолеВладелец = Новый ПолеКомпоновкиДанных("ВладелецКарты");
		Для Каждого ЭлементОтбора Из Список.Отбор.Элементы Цикл
			Если ЭлементОтбора.ЛевоеЗначение = ПолеВладелец Тогда
				ЭО = ЭлементОтбора;
				Прервать;
			КонецЕсли;
		КонецЦикла;
		Если ЭО <> Неопределено 
			И ЭО.Использование
		Тогда
			Если ЗначениеЗаполнено(ЭО.ПравоеЗначение) Тогда
				ВладелецКарты = ЭО.ПравоеЗначение;
				КартыТолькоВладельца = Истина;
			Иначе
				ЭО.Использование = Ложь;
			КонецЕсли;
			Список.Отбор.Элементы.Удалить(ЭлементОтбора);
		Иначе
			
		КонецЕсли;
		ОбновитьСписок();

	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовФормы

&НаКлиенте
Процедура ПоказыватьКартыРодственниковПриИзменении(Элемент)
	ОбновитьСписок();
	Элементы.ВладелецКарты.Видимость = ПоказыватьКартыРодственников Или Не ЗначениеЗаполнено(ВладелецКарты);
КонецПроцедуры

&НаКлиенте
Процедура ВладелецСертификатаПриИзменении(Элемент)
	КартыТолькоВладельца = ЗначениеЗаполнено(ВладелецКарты);
	Элементы.ВладелецКарты.Видимость = ПоказыватьКартыРодственников Или Не ЗначениеЗаполнено(ВладелецКарты);
	ОбновитьСписок();
КонецПроцедуры

&НаКлиенте
Процедура СписокПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа, Параметр)
	
	Если ПоказыватьКартыРодственников И ЗначениеЗаполнено(ВладелецКарты) Тогда
		Отказ = Истина;
		ПараметрыФормы = Новый Структура("ЗначенияЗаполнения", Новый Структура("ВладелецКарты", ВладелецКарты));
		ОткрытьФорму("Справочник.КартыСкидок.ФормаОбъекта", ПараметрыФормы);
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура Обновить(Команда)
	ОбновитьСписок();
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаКлиенте
Процедура ОбновитьСписок()
	
	Если КартыТолькоВладельца Тогда
		Если ПоказыватьКартыРодственников И ЗначениеЗаполнено(ВладелецКарты) Тогда
			СписокКлиентов = РаботаСКлиентамиПереопределяемый.ПолучитьРодственниковКлиента(ВладелецКарты, Истина);
			РаботаСФормамиКлиент.УстановитьОтборСписка("ВладелецКарты", СписокКлиентов, Список);
		Иначе
			РаботаСФормамиКлиент.УстановитьОтборСписка("ВладелецКарты", ВладелецКарты, Список);
		КонецЕсли;
	Иначе
		РаботаСФормамиКлиент.СнятьОтборСписка("ВладелецКарты", Список);
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти
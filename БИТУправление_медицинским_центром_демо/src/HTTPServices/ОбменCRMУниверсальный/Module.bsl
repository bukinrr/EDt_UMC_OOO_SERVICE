#Область СлужебныеПроцедурыИФункции

Функция CreateLeadPOST(Запрос)
	
	ПараметрыЗапроса = ПолучитьПараметрыЗапроса(Запрос);
	
	Параметры = Новый Соответствие;
	Параметры.Вставить("Примечание",	"note");
	Параметры.Вставить("Клиент",		"client");
	Параметры.Вставить("ДатаРождения",	"birthday");
	Параметры.Вставить("НомерТелефона",	"phone");
	Параметры.Вставить("Сотрудник",		"employee");
	Параметры.Вставить("ДатаЗаписи",	"date");
	Параметры.Вставить("Специализация",	"special");
	Параметры.Вставить("Работы",		"service");
	Параметры.Вставить("УИДФилиала",	"branch_uid");
	Параметры.Вставить("UTM_MEDIUM",	"utm_medium");
	Параметры.Вставить("UTM_SOURCE",	"utm_source");
	Параметры.Вставить("UTM_COMPAIGN",	"utm_compaign");
	Параметры.Вставить("UTM_TERM",		"utm_term");
	Параметры.Вставить("UTM_CONTENT",	"utm_content");
	
	Для Каждого Параметр Из Параметры Цикл
		Параметры.Вставить(Параметр.Ключ, ОбщегоНазначенияКлиентСервер.СвойствоСтруктуры(ПараметрыЗапроса, Параметр.Значение));
	КонецЦикла;	
	ОписаниеОшибки = "";
	Попытка
		CRMОбмен.CreateLeadPOST(ОписаниеОшибки, ПараметрыЗапроса, Параметры);
	Исключение
		ОписаниеОшибки = ОписаниеОшибки();
	КонецПопытки;
	КодОтвета = 200;
	Ответ = Новый HTTPСервисОтвет(КодОтвета);
	
	Ответ.Заголовки.Вставить("Content-Type","text/html; charset=utf-8");
	
	Ответ.УстановитьТелоИзСтроки(ОписаниеОшибки);
	Возврат Ответ;
	
КонецФункции

Функция ПолучитьПараметрыЗапроса(Запрос)
	
	ПараметрыЗапроса = Неопределено;
	
	//ТипРесурса = Запрос.Заголовки.Получить("Content-Type");
	
	ТелоЗапроса = Запрос.ПолучитьТелоКакСтроку("UTF-8");
	
	//JSON
	Попытка 
		ЧтениеJSON = Новый ЧтениеJSON; 
		ЧтениеJSON.УстановитьСтроку(ТелоЗапроса); 
		ПараметрыЗапроса = ПрочитатьJSON(ЧтениеJSON, Ложь); 
		ЧтениеJSON.Закрыть();
		Возврат ПараметрыЗапроса;
	Исключение КонецПопытки;
	
	//XML
	Попытка
		ПараметрыЗапроса = ОбщегоНазначения.ЗначениеИзСтрокиXML(ТелоЗапроса);
		Возврат ПараметрыЗапроса;
	Исключение КонецПопытки;
	
	//x-www-form-urlencoded
	Попытка
		Тело = Строка(РаскодироватьСтроку(СтрЗаменить(ТелоЗапроса,"+","%20"),СпособКодированияСтроки.КодировкаURL));
		СтрокиПараметров = СтрРазделить(Тело, "&", Ложь);
		ПараметрыЗапроса = Новый Структура;
		Для Каждого СтрокаПараметра Из СтрокиПараметров Цикл
			
			КлючИЗначение = СтрРазделить(СтрокаПараметра, "=");
			Ключ = КлючИЗначение[0];
			Значение = КлючИЗначение[1];
			Если СтрНайти(Ключ,"[") = 0 Тогда
				ПараметрыЗапроса.Вставить(Ключ,Значение);
			Иначе
				Ключ = Лев(Ключ,СтрНайти(Ключ,"[")-1);
				Если ПараметрыЗапроса.Свойство(Ключ) Тогда
					ПараметрыЗапроса[Ключ].Добавить(Значение);
				Иначе
					ПараметрМассив = Новый Массив;
					ПараметрМассив.Добавить(Значение);
					ПараметрыЗапроса.Вставить(Ключ,ПараметрМассив);
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
		Возврат ПараметрыЗапроса;
	Исключение КонецПопытки;
	
КонецФункции

#КонецОбласти
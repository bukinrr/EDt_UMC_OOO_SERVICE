#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ОбновитьСделку(Команда)
	ОбновитьСделкуНаСервере(Элементы.Список.ТекущиеДанные);
	Элементы.Список.Обновить();
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьВсеСделки(Команда)
	ОбновитьВсеСделкиНаСервере();
	Элементы.Список.Обновить();
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервереБезКонтекста
Процедура ОбновитьСделкуНаСервере(Знач СтрокаЛида)
	
	Если СтрокаЛида <> Неопределено И БитриксПовтИсп.ИспользоватьОбмен() Тогда
		УстановитьПривилегированныйРежим(Истина);
		Битрикс.ОбновитьСделкуНесконвертированногоЛида(СтрокаЛида.ИдентификаторЛида, СтрокаЛида.ДокументСделки);
	КонецЕсли;
	
КонецПроцедуры

&НаСервереБезКонтекста
Процедура ОбновитьВсеСделкиНаСервере()
	
	Если БитриксПовтИсп.ИспользоватьОбмен() Тогда
		УстановитьПривилегированныйРежим(Истина);
		НЗ = РегистрыСведений.Б24_НесконвертированныеЛиды.СоздатьНаборЗаписей();
		НЗ.Прочитать();
		НесконвертированныеЛиды = НЗ.Выгрузить();
		Для Каждого СтрокаЛида Из НесконвертированныеЛиды Цикл
			Битрикс.ОбновитьСделкуНесконвертированногоЛида(СтрокаЛида.ИдентификаторЛида, СтрокаЛида.Документ);
		КонецЦикла;
	КонецЕсли;

КонецПроцедуры

#КонецОбласти